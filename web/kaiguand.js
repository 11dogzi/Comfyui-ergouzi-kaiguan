import{app}from"/scripts/app.js";import{ComfyWidgets}from"/scripts/widgets.js";function toggleGroupNodes(e,t){let o=e.outputs.flatMap(e=>e.links||[]).map(e=>(e=app.graph.links[e])&&app.graph.getNodeById(e.target_id)||null).filter(e=>null!==e);0<(e=app.graph._groups.filter(e=>(e.recomputeInsideNodes(),e._nodes.some(e=>o.includes(e))))).length&&e.forEach(e=>{e._nodes.forEach(e=>{e&&(e.mode=!t?4:LiteGraph.ALWAYS)})}),app.graph.setDirtyCanvas(!0,!0)}function monitorNodeConnections(a){a.onConnectionsChange=(e,t,o,i,s,n,p)=>{toggleGroupNodes(a,a.properties.smooth_edge_switch)}}function showSwitchSettings(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="20px",t.style.backgroundColor="#333",t.style.color="#fff",t.style.border="1px solid #ccc",t.style.zIndex=1e3,t.style.maxHeight="80%",t.style.overflowY="auto",t.style.width="400px";var o=document.createElement("h3");o.textContent="2🐕开关设置【set up】",t.appendChild(o),(o=document.createElement("label")).textContent="开关名称【Switch name】: ",t.appendChild(o);let i=document.createElement("input");i.type="text",i.value=e.properties.switchName||"smooth_edge_switch",i.addEventListener("input",()=>{e.properties.switchName=i.value,updateSwitchWidgetName(e,i.value)}),t.appendChild(i),(o=document.createElement("button")).textContent="灵仙儿和二狗子",o.style.position="absolute",o.style.top="10px",o.style.right="10px",o.style.backgroundColor="#ff69b4",o.style.color="#fff",o.style.border="none",o.style.padding="5px 10px",o.style.borderRadius="5px",o.style.cursor="pointer",o.addEventListener("click",()=>{window.open("https://space.bilibili.com/19723588?spm_id_from=333.1350.jump_directly","_blank")}),t.appendChild(o),(o=document.createElement("button")).textContent="关闭【close】",o.style.marginTop="10px",o.addEventListener("click",()=>{document.body.removeChild(t)}),t.appendChild(o),document.body.appendChild(t)}function updateSwitchWidgetName(e,t){(e=e.widgets.find(e=>"switchNameWidget"===e.name))&&(e.label=t),app.graph.setDirtyCanvas(!0,!0)}function ensureSwitchNameConsistency(e){var t;"GroupSwitchNode"===e.type&&(t=e.properties.switchName)!==((e=e.widgets.find(e=>"switchNameWidget"===e.name))?e.label:"unknown")&&e&&(e.label=t,app.graph.setDirtyCanvas(!0,!0))}function monitorDisplayedSwitchName(){app.graph._nodes.filter(e=>"GroupSwitchNode"===e.type).forEach(e=>{var t=e.widgets.find(e=>"switchNameWidget"===e.name),o=t?t.label:"unknown",e=e.properties.switchName;e!==o&&(t.label=e,app.graph.setDirtyCanvas(!0,!0))})}let originalGetNodeMenuOptions=LGraphCanvas.prototype.getNodeMenuOptions;LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=originalGetNodeMenuOptions.apply(this,arguments);return"GroupSwitchNode"===e.type&&t.push({content:"2🐕开关设置【set up】",callback:()=>showSwitchSettings(e)}),t},app.registerExtension({name:"Comfy.GroupSwitch",async beforeRegisterNodeDef(e,t,o){"GroupSwitchNode"===t.name&&(e.prototype.onNodeCreated=function(){var e;this._initialized||(this._initialized=!0,this.properties={switchName:"smooth_edge_switch",smooth_edge_switch:!1},(e=ComfyWidgets.BOOLEAN(this,"switchNameWidget",{default:!1,label_on:"True",label_off:"False"})).widget.callback=e=>{this.properties.smooth_edge_switch=e,toggleGroupNodes(this,e)},this.widgets=[e.widget],monitorNodeConnections(this))},e.prototype.onSerialize=function(e){e.properties=this.properties},e.prototype.onConfigure=function(e){this.properties=e.properties||{switchName:"smooth_edge_switch",smooth_edge_switch:!1},ensureSwitchNameConsistency(this),toggleGroupNodes(this,this.properties.smooth_edge_switch)})}}),setInterval(monitorDisplayedSwitchName,1e3);