import{app}from"/scripts/app.js";import{ComfyWidgets}from"/scripts/widgets.js";function generateGroupId(e){return`${e.title}_${e._bounding[0]}_`+e._bounding[1]}function showSwitchSettings(n){let e=document.createElement("div");e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="20px",e.style.backgroundColor="#333",e.style.color="#fff",e.style.border="1px solid #ccc",e.style.zIndex=1e3,e.style.maxHeight="80%",e.style.overflowY="auto",e.style.width="400px";var t=document.createElement("h3");t.textContent="2üêïÂºÄÂÖ≥ËÆæÁΩÆ„Äêset up„Äë",e.appendChild(t),(t=document.createElement("label")).textContent="ÂºÄÂÖ≥ÂêçÁß∞„ÄêSwitch name„Äë: ",e.appendChild(t);let o=document.createElement("input");o.type="text",o.value=n.properties.switchName||"smooth_edge_switch",o.addEventListener("input",()=>{var e=o.value;n.properties.switchName=e,updateSwitchWidgetName(n,e)}),e.appendChild(o);var a=document.createElement("table"),t=(a.style.width="100%",a.style.borderCollapse="collapse",a.style.color="#fff",(t=document.createElement("tr")).innerHTML="<th style='text-align: left;'>ÁªÑGroup</th><th>ÂøΩÁï•Bypass</th><th>Á¶ÅÁî®Disable</th>",t.style.borderBottom="1px solid #ccc",a.appendChild(t),app.graph._groups||[]),p=(0===t.length?((p=document.createElement("tr")).innerHTML="<td colspan='3' style='text-align: center; padding: 10px;'>Ê≤°ÊúâÊâæÂà∞ÁªÑNo group found</td>",a.appendChild(p)):t.forEach(e=>{let t=generateGroupId(e),o=document.createElement("tr");var p=document.createElement("input"),p=(p.type="hidden",p.value=t,o.appendChild(p),document.createElement("td")),e=(p.textContent=e.title,o.appendChild(p),document.createElement("td"));let i=document.createElement("input"),s=(i.type="checkbox",i.checked=n.properties.bypassGroups.includes(t),i.addEventListener("change",()=>{i.checked?(n.properties.bypassGroups.push(t),n.properties.disableGroups=n.properties.disableGroups.filter(e=>e!==t),o.querySelectorAll("input[type='checkbox']").forEach(e=>{e!==i&&(e.checked=!1)})):n.properties.bypassGroups=n.properties.bypassGroups.filter(e=>e!==t),handleGroupControl(n)}),e.appendChild(i),o.appendChild(e),document.createElement("td")),r=document.createElement("input");r.type="checkbox",r.checked=n.properties.disableGroups.includes(t),r.addEventListener("change",()=>{r.checked?(n.properties.disableGroups.push(t),n.properties.bypassGroups=n.properties.bypassGroups.filter(e=>e!==t),o.querySelectorAll("input[type='checkbox']").forEach(e=>{e!==r&&(e.checked=!1)})):n.properties.disableGroups=n.properties.disableGroups.filter(e=>e!==t),handleGroupControl(n)}),s.appendChild(r),o.appendChild(s),o.style.borderBottom="1px solid #ccc",a.appendChild(o)}),e.appendChild(a),document.createElement("button"));p.textContent="ÂÖ≥Èó≠„Äêclose„Äë",p.style.marginTop="10px",p.addEventListener("click",()=>{document.body.removeChild(e),handleGroupControl(n)}),e.appendChild(p),document.body.appendChild(e)}function updateSwitchWidgetName(e,t){(e=e.widgets.find(e=>"switchNameWidget"===e.name))&&(e.label=t,app.graph.setDirtyCanvas(!0,!0))}function setGlobalNode(t){app.graph._nodes.forEach(e=>{"GroupSwitchNodeeee"===e.type&&e!==t&&(e.properties.smooth_edge_switch=!1,updateNodeWidgets(e),handleGroupControl(e))})}function updateNodeWidgets(e){(e=e.widgets.find(e=>"switchNameWidget"===e.name))&&(e.value=!1)}function handleGroupControl(e){let o=e.properties.smooth_edge_switch,p=e.properties.bypassGroups,i=e.properties.disableGroups;(app.graph._groups||[]).forEach(e=>{let t=generateGroupId(e);e._nodes.some(e=>e&&["hulue","jinyong","ALLty"].includes(e.type))||(e.recomputeInsideNodes(),e._nodes.forEach(e=>{e&&(o?p.includes(t)?e.mode=4:i.includes(t)&&(e.mode=LiteGraph.NEVER):e.mode=LiteGraph.ALWAYS)}))}),app.graph.setDirtyCanvas(!0,!0)}function ensureSwitchNameConsistency(e){var t;"GroupSwitchNodeeee"===e.type&&(t=e.properties.switchName,e=e.widgets.find(e=>"switchNameWidget"===e.name))&&t!==e.label&&(e.label=t,app.graph.setDirtyCanvas(!0,!0))}function monitorDisplayedSwitchName(){app.graph._nodes.filter(e=>"GroupSwitchNodeeee"===e.type).forEach(e=>{var t=e.widgets.find(e=>"switchNameWidget"===e.name),o=t?t.label:"unknown",e=e.properties.switchName;e!==o&&(t.label=e,app.graph.setDirtyCanvas(!0,!0))})}let originalGetNodeMenuOptions=LGraphCanvas.prototype.getNodeMenuOptions;LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=originalGetNodeMenuOptions.apply(this,arguments);return"GroupSwitchNodeeee"===e.type&&t.push({content:"2üêïÂºÄÂÖ≥ËÆæÁΩÆ„Äêset up„Äë",callback:()=>showSwitchSettings(e)}),t},app.registerExtension({name:"Comfy.GroupSwitchNodeeee",async beforeRegisterNodeDef(e,t,o){"GroupSwitchNodeeee"===t.name&&(e.prototype.onNodeCreated=function(){var e;this._initialized||(this._initialized=!0,this.properties={switchName:"smooth_edge_switch",smooth_edge_switch:!1,bypassGroups:[],disableGroups:[]},(e=ComfyWidgets.BOOLEAN(this,"switchNameWidget",{default:!1,label_on:"True",label_off:"False"})).widget.callback=e=>{this.properties.smooth_edge_switch=e,setGlobalNode(this),handleGroupControl(this)},this.widgets=[e.widget])},e.prototype.onSerialize=function(e){e.properties=this.properties},e.prototype.onConfigure=function(e){this.properties=e.properties||{switchName:"smooth_edge_switch",smooth_edge_switch:!1,bypassGroups:[],disableGroups:[]},ensureSwitchNameConsistency(this),handleGroupControl(this)})}}),setInterval(monitorDisplayedSwitchName,1e3);