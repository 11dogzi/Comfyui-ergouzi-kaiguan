import{app}from"/scripts/app.js";import{ComfyWidgets}from"/scripts/widgets.js";function generateGroupId(e){return`${e.title}_${e._bounding[0]}_`+e._bounding[1]}function showSwitchSettings(r){let e=document.createElement("div");e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="20px",e.style.backgroundColor="#333",e.style.color="#fff",e.style.border="1px solid #ccc",e.style.zIndex=1e3,e.style.maxHeight="80%",e.style.overflowY="auto",e.style.width="400px";var t=document.createElement("h3"),t=(t.textContent="2üêïÂºÄÂÖ≥ËÆæÁΩÆ„Äêset up„Äë",e.appendChild(t),document.createElement("label"));t.textContent="ÂºÄÂÖ≥ÂêçÁß∞„ÄêSwitch name„Äë:",e.appendChild(t);let o=document.createElement("input"),n=(o.type="text",o.value=r.properties.switchName||"smooth_edge_switch",o.addEventListener("input",()=>{var e=o.value;r.properties.switchName=e,updateSwitchWidgetName(r,e)}),e.appendChild(o),document.createElement("table"));n.style.width="100%",n.style.borderCollapse="collapse",n.style.color="#fff";var t=document.createElement("tr"),t=(t.innerHTML="<th style='text-align: left;'>ÁªÑGroup</th><th>ÂøΩÁï•Bypass</th><th>Á¶ÅÁî®Disable</th>",t.style.borderBottom="1px solid #ccc",n.appendChild(t),app.graph._groups||[]),p=(0===t.length?((p=document.createElement("tr")).innerHTML="<td colspan='3' style='text-align: center; padding: 10px;'>Ê≤°ÊúâÊâæÂà∞ÁªÑNo group found</td>",n.appendChild(p)):t.forEach(e=>{let t=generateGroupId(e),o=document.createElement("tr");var p=document.createElement("input"),p=(p.type="hidden",p.value=t,o.appendChild(p),document.createElement("td")),e=(p.textContent=e.title,o.appendChild(p),document.createElement("td"));let s=document.createElement("input");s.type="checkbox",s.checked=r.properties.bypassGroups.includes(t),s.addEventListener("change",()=>{s.checked?(r.properties.bypassGroups.push(t),r.properties.disableGroups=r.properties.disableGroups.filter(e=>e!==t),o.querySelectorAll("input[type='checkbox']").forEach(e=>{e!==s&&(e.checked=!1)})):r.properties.bypassGroups=r.properties.bypassGroups.filter(e=>e!==t),handleGroupControl(r)}),e.appendChild(s),o.appendChild(e);p=document.createElement("td");let i=document.createElement("input");i.type="checkbox",i.checked=r.properties.disableGroups.includes(t),i.addEventListener("change",()=>{i.checked?(r.properties.disableGroups.push(t),r.properties.bypassGroups=r.properties.bypassGroups.filter(e=>e!==t),o.querySelectorAll("input[type='checkbox']").forEach(e=>{e!==i&&(e.checked=!1)})):r.properties.disableGroups=r.properties.disableGroups.filter(e=>e!==t),handleGroupControl(r)}),p.appendChild(i),o.appendChild(p),o.style.borderBottom="1px solid #ccc",n.appendChild(o)}),e.appendChild(n),document.createElement("button")),t=(p.textContent="ÁÅµ‰ªôÂÑøÂíå‰∫åÁãóÂ≠ê",p.style.position="absolute",p.style.top="10px",p.style.right="10px",p.style.backgroundColor="#ff69b4",p.style.color="#fff",p.style.border="none",p.style.padding="5px 10px",p.style.borderRadius="5px",p.style.cursor="pointer",p.addEventListener("click",()=>{window.open("https://space.bilibili.com/19723588?spm_id_from=333.1350.jump_directly","_blank")}),e.appendChild(p),document.createElement("button"));t.textContent="ÂÖ≥Èó≠„Äêclose„Äë",t.style.marginTop="10px",t.addEventListener("click",()=>{document.body.removeChild(e),handleGroupControl(r)}),e.appendChild(t),document.body.appendChild(e)}let originalGetNodeMenuOptions=LGraphCanvas.prototype.getNodeMenuOptions;function updateSwitchWidgetName(e,t){e=e.widgets.find(e=>"switchNameWidget"===e.name);e&&(e.label=t),app.graph.setDirtyCanvas(!0,!0)}function setGlobalNode(t){app.graph._nodes.forEach(e=>{"GroupSwitchNodeeee"===e.type&&e!==t&&(e.properties.smooth_edge_switch=!1,updateNodeWidgets(e),handleGroupControl(e))})}function updateNodeWidgets(e){e=e.widgets.find(e=>"switchNameWidget"===e.name);e&&(e.value=!1)}function handleGroupControl(e){let o=e.properties.smooth_edge_switch,p=e.properties.bypassGroups,s=e.properties.disableGroups;(app.graph._groups||[]).forEach(e=>{e.recomputeInsideNodes();let t=generateGroupId(e);e._nodes.forEach(e=>{e&&(o?p.includes(t)?e.mode=4:s.includes(t)&&(e.mode=LiteGraph.NEVER):e.mode=LiteGraph.ALWAYS)})}),app.graph.setDirtyCanvas(!0,!0)}LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=originalGetNodeMenuOptions.apply(this,arguments);return"GroupSwitchNodeeee"===e.type&&t.push({content:"2üêïÂºÄÂÖ≥ËÆæÁΩÆ„Äêset up„Äë",callback:()=>showSwitchSettings(e)}),t},app.registerExtension({name:"Comfy.GroupSwitchNodeeee",async beforeRegisterNodeDef(e,t,o){"GroupSwitchNodeeee"===t.name&&(e.prototype.onNodeCreated=function(){var e;this._initialized||(this._initialized=!0,this.properties={switchName:"smooth_edge_switch",smooth_edge_switch:!1,bypassGroups:[],disableGroups:[]},(e=ComfyWidgets.BOOLEAN(this,"switchNameWidget",{default:!"smooth_edge_switch",label_on:"True",label_off:"False"})).widget.callback=e=>{this.properties.smooth_edge_switch=e,setGlobalNode(this),handleGroupControl(this)},this.widgets=[e.widget])},e.prototype.onSerialize=function(e){e.properties=this.properties},e.prototype.onConfigure=function(e){this.properties=e.properties||{switchName:"smooth_edge_switch",smooth_edge_switch:!1,bypassGroups:[],disableGroups:[]},updateSwitchWidgetName(this,this.properties.switchName),handleGroupControl(this)})}});